from opentrons import protocol_api

config = {
	"PLATES": {"P3": {"A1": 0, "B1": 0, "C1": 22.0, "D1": 5.9, "E1": 0, "F1": 0, "G1": 0, "H1": 17.7, "A2": 100.4, "B2": 0, "C2": 0, "D2": 93.9, "E2": 17.1, "F2": 0, "G2": 51.2, "H2": 0, "A3": 0, "B3": 0, "C3": 0, "D3": 52.3, "E3": 0, "F3": 0, "G3": 23.2, "H3": 9.8, "A4": 0, "B4": 0, "C4": 0, "D4": 40.1, "E4": 0, "F4": 0, "G4": 36.7, "H4": 0, "A5": 0, "B5": 0, "C5": 0, "D5": 0, "E5": 0, "F5": 0, "G5": 0, "H5": 0, "A6": 14.8, "B6": 50.2, "C6": 0, "D6": 32.8, "E6": 0, "F6": 79.3, "G6": 0, "H6": 0, "A7": 0, "B7": 33.6, "C7": 8.2, "D7": 48.2, "E7": 0, "F7": 6.5, "G7": 15.3, "H7": 5.2, "A8": 0, "B8": 0, "C8": 26.1, "D8": 5.9, "E8": 8.9, "F8": 69.8, "G8": 0, "H8": 0, "A9": 22.3, "B9": 0, "C9": 8.6, "D9": 0, "E9": 8.9, "F9": 65.9, "G9": 0, "H9": 47.8, "A10": 0, "B10": 14.2, "C10": 0, "D10": 0, "E10": 21.4, "F10": 19.7, "G10": 34.6, "H10": 34.1, "A11": 0, "B11": 0, "C11": 0, "D11": 0, "E11": 0, "F11": 16.0, "G11": 59.6, "H11": 0, "A12": 0, "B12": 106.3, "C12": 0, "D12": 0, "E12": 0, "F12": 0, "G12": 0, "H12": 13.1}, "P4": {"A1": 0, "B1": 0, "C1": 0, "D1": 0, "E1": 0, "F1": 73.2, "G1": 60.5, "H1": 35.5, "A2": 0, "B2": 62.6, "C2": 0, "D2": 0, "E2": 0, "F2": 16.6, "G2": 0, "H2": 46.9, "A3": 16.9, "B3": 44.9, "C3": 0, "D3": 0, "E3": 0, "F3": 83.2, "G3": 5.1, "H3": 0, "A4": 45.0, "B4": 0, "C4": 0, "D4": 0, "E4": 61.1, "F4": 0, "G4": 0, "H4": 6.2, "A5": 0, "B5": 0, "C5": 0, "D5": 0, "E5": 24.7, "F5": 64.6, "G5": 0, "H5": 13.2, "A6": 16.4, "B6": 0, "C6": 0, "D6": 0, "E6": 0, "F6": 0, "G6": 13.2, "H6": 14.9, "A7": 0, "B7": 0, "C7": 7.5, "D7": 36.7, "E7": 0, "F7": 81.3, "G7": 13.9, "H7": 0, "A8": 0, "B8": 6.4, "C8": 40.1, "D8": 37.5, "E8": 0, "F8": 0, "G8": 0, "H8": 0, "A9": 0, "B9": 0, "C9": 0, "D9": 18.1, "E9": 0, "F9": 9.9, "G9": 0, "H9": 5.8, "A10": 0, "B10": 63.0, "C10": 0, "D10": 0, "E10": 22.2, "F10": 0, "G10": 0, "H10": 0, "A11": 0, "B11": 5.4, "C11": 0, "D11": 0, "E11": 0, "F11": 0, "G11": 30.0, "H11": 43.9, "A12": 30.2, "B12": 0, "C12": 0, "D12": 0, "E12": 0, "F12": 0, "G12": 0, "H12": 0}, "P5": {"A1": 0, "B1": 70.6, "C1": 29.3, "D1": 0, "E1": 86.4, "F1": 0, "G1": 0, "H1": 6.2, "A2": 0, "B2": 117.0, "C2": 54.3, "D2": 101.2, "E2": 92.6, "F2": 91.1, "G2": 34.6, "H2": 16.4, "A3": 37.0, "B3": 122.8, "C3": 43.1, "D3": 91.3, "E3": 93.7, "F3": 33.3, "G3": 47.8, "H3": 23.6, "A4": 0, "B4": 0, "C4": 69.5, "D4": 0, "E4": 27.1, "F4": 0, "G4": 5.8, "H4": 0, "A5": 0, "B5": 102.8, "C5": 107.5, "D5": 47.1, "E5": 43.2, "F5": 75.0, "G5": 112.3, "H5": 52.5, "A6": 123.0, "B6": 37.5, "C6": 0, "D6": 0, "E6": 29.5, "F6": 88.3, "G6": 73.2, "H6": 49.3, "A7": 0, "B7": 72.3, "C7": 42.1, "D7": 35.0, "E7": 47.3, "F7": 45.5, "G7": 0, "H7": 74.3, "A8": 33.2, "B8": 16.9, "C8": 9.2, "D8": 28.1, "E8": 9.8, "F8": 88.2, "G8": 75.7, "H8": 30.7, "A9": 54.0, "B9": 0, "C9": 5.4, "D9": 23.3, "E9": 17.1, "F9": 0, "G9": 79.0, "H9": 0, "A10": 0, "B10": 49.6, "C10": 0, "D10": 0, "E10": 55.3, "F10": 69.9, "G10": 0, "H10": 0, "A11": 67.4, "B11": 40.3, "C11": 150.6, "D11": 90.0, "E11": 59.3, "F11": 0, "G11": 36.9, "H11": 59.0, "A12": 0, "B12": 130.0, "C12": 7.9, "D12": 97.8, "E12": 18.1, "F12": 80.6, "G12": 43.1, "H12": 30.9}, "P6": {"A1": 0, "B1": 6.9, "C1": 0, "D1": 0, "E1": 0, "F1": 27.3, "G1": 56.0, "H1": 0, "A2": 10.9, "B2": 0, "C2": 0, "D2": 0, "E2": 0, "F2": 0, "G2": 55.7, "H2": 0, "A3": 0, "B3": 12.7, "C3": 0, "D3": 0, "E3": 0, "F3": 0, "G3": 0, "H3": 69.7, "A4": 0, "B4": 0, "C4": 30.2, "D4": 0, "E4": 0, "F4": 0, "G4": 43.9, "H4": 0, "A5": 99.7, "B5": 0, "C5": 0, "D5": 0, "E5": 0, "F5": 0, "G5": 0, "H5": 0, "A6": 91.2, "B6": 0, "C6": 0, "D6": 0, "E6": 40.5, "F6": 0, "G6": 28.3, "H6": 0, "A7": 89.7, "B7": 0, "C7": 59.5, "D7": 0, "E7": 16.8, "F7": 30.2, "G7": 0, "H7": 17.1, "A8": 0, "B8": 8.8, "C8": 0, "D8": 42.2, "E8": 26.1, "F8": 0, "G8": 0, "H8": 0, "A9": 35.6, "B9": 6.9, "C9": 78.8, "D9": 31.2, "E9": 0, "F9": 0, "G9": 0, "H9": 28.5, "A10": 0, "B10": 0, "C10": 0, "D10": 0, "E10": 0, "F10": 0, "G10": 0, "H10": 7.6, "A11": 16.5, "B11": 0, "C11": 54.9, "D11": 59.4, "E11": 0, "F11": 5.3, "G11": 0, "H11": 8.7, "A12": 73.4, "B12": 0, "C12": 63.2, "D12": 0, "E12": 43.9, "F12": 0, "G12": 0, "H12": 0}, "P7": {"A1": 0, "B1": 0, "C1": 0, "D1": 0, "E1": 0, "F1": 69.3, "G1": 0, "H1": 0, "A2": 7.8, "B2": 0, "C2": 0, "D2": 0, "E2": 0, "F2": 0, "G2": 0, "H2": 0, "A3": 0, "B3": 41.4, "C3": 40.0, "D3": 0, "E3": 0, "F3": 8.9, "G3": 61.4, "H3": 0, "A4": 63.7, "B4": 0, "C4": 0, "D4": 17.1, "E4": 25.0, "F4": 9.9, "G4": 0, "H4": 0, "A5": 7.5, "B5": 0, "C5": 0, "D5": 0, "E5": 0, "F5": 0, "G5": 22.1, "H5": 14.7, "A6": 0, "B6": 0, "C6": 8.9, "D6": 0, "E6": 0, "F6": 0, "G6": 0, "H6": 0, "A7": 0, "B7": 0, "C7": 0, "D7": 0, "E7": 0, "F7": 0, "G7": 0, "H7": 0, "A8": 0, "B8": 5.4, "C8": 0, "D8": 0, "E8": 0, "F8": 0, "G8": 0, "H8": 0, "A9": 0, "B9": 0, "C9": 0, "D9": 0, "E9": 0, "F9": 0, "G9": 0, "H9": 0, "A10": 0, "B10": 0, "C10": 0, "D10": 10.9, "E10": 5.9, "F10": 0, "G10": 0, "H10": 0, "A11": 0, "B11": 0, "C11": 0, "D11": 0, "E11": 0, "F11": 0, "G11": 0, "H11": 0, "A12": 0, "B12": 0, "C12": 0, "D12": 0, "E12": 0, "F12": 0, "G12": 0, "H12": 0}, "PCE001": {"A1": 115.3, "B1": 37.5, "C1": 128.3, "D1": 70.4, "E1": 134.4, "F1": 156.5, "G1": 85.2, "H1": 175.7, "A2": 81.0, "B2": 100.6, "C2": 63.4, "D2": 85.0, "E2": 74.6, "F2": 80.5, "G2": 66.4, "H2": 59.8, "A3": 54.2, "B3": 71.7, "C3": 103.4, "D3": 110.4, "E3": 82.6, "F3": 84.6, "G3": 73.0, "H3": 97.9, "A4": 80.1, "B4": 95.7, "C4": 101.0, "D4": 62.1, "E4": 66.2, "F4": 79.4, "G4": 64.0, "H4": 109.5, "A5": 70.7, "B5": 96.0, "C5": 70.0, "D5": 36.6, "E5": 66.4, "F5": 48.6, "G5": 74.6, "H5": 83.8, "A6": 75.4, "B6": 74.9, "C6": 10.4, "D6": 78.8, "E6": 56.0, "F6": 69.8, "G6": 50.6, "H6": 82.2, "A7": 83.0, "B7": 5.8, "C7": 77.1, "D7": 77.8, "E7": 50.2, "F7": 95.4, "G7": 85.0, "H7": 93.5, "A8": 99.8, "B8": 39.8, "C8": 97.9, "D8": 61.6, "E8": 73.0, "F8": 77.7, "G8": 75.5, "H8": 87.1, "A9": 83.4, "B9": 89.8, "C9": 58.3, "D9": 72.8, "E9": 86.1, "F9": 68.4, "G9": 59.4, "H9": 53.9, "A10": 72.9, "B10": 80.4, "C10": 81.9, "D10": 60.9, "E10": 62.4, "F10": 61.8, "G10": 60.6, "H10": 88.5, "A11": 66.8, "B11": 84.9, "C11": 84.2, "D11": 44.1, "E11": 65.1, "F11": 94.8, "G11": 78.6, "H11": 26.1, "A12": 80.5, "B12": 88.5, "C12": 69.5, "D12": 93.9, "E12": 89.7, "F12": 53.8, "G12": 96.8, "H12": 54.3}},
	"WELL_MAX_VOLUME": 190.0,
}

metadata = {
        'protocolName': "P3__P4__P5__P6__P7__PCE001",
        'author': 'Kevin Murray',
        'apiLevel': '2.9',
}

def dispense_water_to(plate, water, well_vols, pipette):
    pipette.pick_up_tip()
    for well, volume in well_vols.items():
        if volume < pipette.min_volume:
            continue
        if volume > config["WELL_MAX_VOLUME"]:
            raise ValueError(f"ERROR! overfull well {well} on plate {plate}")
        transferred = 0
        while transferred < volume:
	    todo = volume-transferred
	    if todo > pipette.max_volume and todo <= pipette.max_volume*2:
	    	vol = todo/2
	    else:
                vol = min(todo, pipette.max_volume)
            pipette.aspirate(vol, water["A1"], rate=1)
            pipette.dispense(vol, plate[well], rate=1)
            transferred += vol
        pipette.blow_out(plate[well])
        pipette.touch_tip(plate[well])
    pipette.drop_tip()


def run(protocol: protocol_api.ProtocolContext):
    water = protocol.load_labware('integra_1_reservoir_150ml', 11)

    tiprack_p200 = protocol.load_labware('standard_96_tiprack_200ul', 10)
    p50 = protocol.load_instrument('p50_single', 'left', tip_racks=[tiprack_p200])
    p50.well_bottom_clearance.aspirate = 0
    p50.well_bottom_clearance.dispense = 0

    #tiprack_p10 = protocol.load_labware('standard_96_tiprack_10ul', 9)
    #p10 = protocol.load_instrument('p10_single', 'right', tip_racks=[tiprack_p10])
    #p10.well_bottom_clearance.aspirate = 0.5
    #p10.well_bottom_clearance.dispense = 0.5

    pos = 1
    for plate_name, well_vols in config["PLATES"].items():
        dest_plate = protocol.load_labware('axygen_96_wellplate_200ul', pos, label=plate_name)
        dispense_water_to(dest_plate, water, well_vols, p50)
	pos += 1
