from opentrons import protocol_api

metadata = {
        'protocolName': 'NormPlatePrepPaco',
        'author': 'Kevin Murray',
        'apiLevel': '2.9',
}

CONFIG={"1": {"A01": 0, "B01": 0, "C01": 0, "D01": 103.06355840200156, "E01": 19.638887925191145, "F01": 0, "G01": 45.87831649171153, "H01": 0, "A02": 0, "B02": 0, "C02": 0, "D02": 0, "E02": 0, "F02": 0, "G02": 0, "H02": 71.7913724942807, "A03": 131.35364052502848, "B03": 0, "C03": 13.429093017031548, "D03": 68.93663199903823, "E03": 0, "F03": 0, "G03": 0, "H03": 65.85304283100136, "A04": 119.31561354457637, "B04": 55.71035229446154, "C04": 0, "D04": 116.27603373669228, "E04": 0, "F04": 44.1358905742852, "G04": 49.12361805826486, "H04": 92.29680036812417, "A05": 31.2088745187473, "B05": 54.91231589702478, "C05": 96.39553877701803, "D05": 0, "E05": 0, "F05": 0, "G05": 48.803816707821454, "H05": 0, "A06": 0, "B06": 107.11915286757434, "C06": 0, "D06": 36.49879960910926, "E06": 0, "F06": 0, "G06": 0, "H06": 65.21637408745808, "A07": 0, "B07": 0, "C07": 0, "D07": 0, "E07": 0, "F07": 48.489883272065086, "G07": 0, "H07": 0, "A08": 0, "B08": 0, "C08": 0, "D08": 0, "E08": 0, "F08": 86.04160331174496, "G08": 0, "H08": 11.912237070433022, "A09": 0, "B09": 0, "C09": 0, "D09": 0, "E09": 0, "F09": 0, "G09": 0, "H09": 0, "A10": 80.02405680019066, "B10": 51.74070800868242, "C10": 0, "D10": 0, "E10": 85.33745354930076, "F10": 0, "G10": 0, "H10": 0, "A11": 78.45732357875234, "B11": 0, "C11": 0, "D11": 68.65497209406054, "E11": 0, "F11": 0, "G11": 0, "H11": 0, "A12": 6.991990605354253, "B12": 0, "C12": 0, "D12": 27.67932383449581, "E12": 0, "F12": 66.06722171707814, "G12": 0, "H12": 0}, "2": {"A01": 0, "B01": 0, "C01": 0, "D01": 0, "E01": 0, "F01": 0, "G01": 5.738162676467301, "H01": 111.59499200522895, "A02": 0, "B02": 0, "C02": 0, "D02": 70.59791901367112, "E02": 0, "F02": 0, "G02": 0, "H02": 47.27469895358061, "A03": 0, "B03": 70.6512427734935, "C03": 29.34014106665211, "D03": 0, "E03": 0, "F03": 0, "G03": 0, "H03": 0, "A04": 44.99658943672431, "B04": 0, "C04": 61.46178149743599, "D04": 0, "E04": 102.2307583127498, "F04": 0, "G04": 0, "H04": 0, "A05": 0, "B05": 76.89604753491491, "C05": 0, "D05": 8.662371979972097, "E05": 11.873647293720108, "F05": 0, "G05": 11.849947844910162, "H05": 0, "A06": 60.43085547420323, "B06": 144.8956910328595, "C06": 46.987343136759975, "D06": 0, "E06": 0, "F06": 0, "G06": 0, "H06": 0, "A07": 44.65887229118253, "B07": 0, "C07": 0, "D07": 0, "E07": 0, "F07": 9.672560985496148, "G07": 60.80708422406117, "H07": 0, "A08": 0, "B08": 29.820054905053567, "C08": 0, "D08": 102.01450084235903, "E08": 0, "F08": 15.887741435905127, "G08": 70.26020186812936, "H08": 0, "A09": 0, "B09": 95.65416126798911, "C09": 0, "D09": 0, "E09": 0, "F09": 65.1292712007755, "G09": 0, "H09": 59.23403330930084, "A10": 8.022486862103488, "B10": 46.24377293034784, "C10": 0, "D10": 0, "E10": 0, "F10": 0, "G10": 120.15050404417207, "H10": 107.73495529886031, "A11": 0, "B11": 0, "C11": 0, "D11": 16.409129309723987, "E11": 0, "F11": 10.202836152618744, "G11": 0, "H11": 135.33592586914654, "A12": 0, "B12": 0, "C12": 0, "D12": 0, "E12": 77.04120665887585, "F12": 0, "G12": 25.459356324023055, "H12": 0}, "3": {"A01": 86.4375493615948, "B01": 0, "C01": 0, "D01": 0, "E01": 0, "F01": 0, "G01": 66.17444210153288, "H01": 0, "A02": 0, "B02": 0, "C02": 0, "D02": 0, "E02": 85.79103655034385, "F02": 0, "G02": 0, "H02": 0, "A03": 0, "B03": 149.22789317427498, "C03": 85.0548573753263, "D03": 0, "E03": 35.43043872571489, "F03": 0, "G03": 0, "H03": 0, "A04": 0, "B04": 115.94797271081484, "C04": 0, "D04": 0, "E04": 0, "F04": 0, "G04": 0, "H04": 0, "A05": 116.8261057177864, "B05": 0, "C05": 53.79200182637607, "D05": 0, "E05": 13.889770039664171, "F05": 54.73285861955989, "G05": 0, "H05": 23.209204170042902, "A06": 0, "B06": 0, "C06": 0, "D06": 0, "E06": 0, "F06": 55.92461055759273, "G06": 24.859830122996982, "H06": 0, "A07": 0, "B07": 82.92224864410966, "C07": 159.62353542597975, "D07": 0, "E07": 0, "F07": 0, "G07": 0, "H07": 8.683695784047007, "A08": 0, "B08": 38.06813899853552, "C08": 103.00376398774895, "D08": 35.19604984039542, "E08": 0, "F08": 0, "G08": 40.35590656932986, "H08": 0, "A09": 55.48224280220104, "B09": 0, "C09": 14.972580664802049, "D09": 0, "E09": 13.529933581920183, "F09": 95.093964421193, "G09": 0, "H09": 0, "A10": 0, "B10": 0, "C10": 78.99375887607891, "D10": 0, "E10": 129.0803527925175, "F10": 0, "G10": 0, "H10": 71.10376682095844, "A11": 81.08675258442472, "B11": 0, "C11": 14.252907749314076, "D11": 0, "E11": 0, "F11": 0, "G11": 0, "H11": 0, "A12": 0, "B12": 0, "C12": 0, "D12": 0, "E12": 0, "F12": 0, "G12": 0, "H12": 0}}

def dispense_water_to(plate, water, well_vols, pipette):
    pipette.pick_up_tip()
    for well, volume in well_vols.items():
        if volume < pipette.min_volume:
            continue
        if volume > config["WELL_MAX_VOLUME"]:
            raise ValueError(f"ERROR! overfull well {well} on plate {plate}")
        transferred = 0
        while transferred < volume:
            vol = min(volume-transferred, pipette.max_volume)
            pipette.aspirate(vol, water["A1"], rate=0.2)
            pipette.dispense(vol, plate[well], rate=0.5)
            transferred += vol
        pipette.blow_out(plate[well])
        pipette.touch_tip(plate[well])
    pipette.drop_tip()


def run(protocol: protocol_api.ProtocolContext):
    water = protocol.load_labware('nest_1_reservoir_195ml', 11)

    tiprack_p200 = protocol.load_labware('standard_96_tiprack_200ul', 10)
    p50 = protocol.load_instrument('p50_single', 'left', tip_racks=[tiprack_p200])
    p50.well_bottom_clearance.aspirate = 0
    p50.well_bottom_clearance.dispense = 0

    #tiprack_p10 = protocol.load_labware('standard_96_tiprack_10ul', 9)
    #p10 = protocol.load_instrument('p10_single', 'right', tip_racks=[tiprack_p10])
    #p10.well_bottom_clearance.aspirate = 0.5
    #p10.well_bottom_clearance.dispense = 0.5

    for plate_pos, well_vols in config["PLATES"].items():
        dest_plate = protocol.load_labware('axygen_96_wellplate_200ul', plate_pos)
        dispense_water_to(dest_plate, water, well_vols, p50)
